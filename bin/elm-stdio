#!/usr/bin/env node
"use strict";

var path = require("path");
var argv = require("argv");
var pkg = require("../package.json");
var stdio = require("../stdio");

// Parse argv
argv.version("v" + pkg.version);
argv.info("Example: elm-stdio ./elm.js");
argv.option({
    name: "name",
    short: "n",
    type: "string",
    description: "Name of the exposed module to call",
    example: "'elm-stdio --name=Main'"
});
argv.option({
    name: "encode",
    short: "e",
    type: "boolean",
    description: "Set if you want to get text-entries like <>& as &lt; &gt; &amp;",
    example: "'elm-stdio --encode=1'"
});

var args = argv.run();
var target = args.targets[0];
var name = args.options.name;
var encode = args.options.encode;

if(!target) {
  process.stderr.write("No target specified\n");
  process.exit(1);
}

if(!name) {
  process.stderr.write("No name specified\n");
  process.exit(1);
}

// Load module
var Elm = require(path.resolve(process.cwd(), target));

// Wait for data to be piped
var data = "";

process.stdin.on("data", function (chunk) {
  data += chunk;
});

process.stdin.on("end", function () {
  // Treat all output as error
  var err = "";
  var _write = process.stdout.write.bind(process.stdout);

  process.stdout.write = (msg) => {
    err += msg;
  };

  // Invoke elm module
  stdio(Elm, data, name, encode, function (_, response) {
    if(err) {
      process.stderr.write("error");
      process.stderr.write(err);
      process.exitCode = 1;
    }
    else {
      _write(response);
    }
  });
});
